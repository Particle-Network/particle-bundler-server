import { FetchRequest, JsonRpcProvider, Network, Wallet } from 'ethers';
import { PROVIDER_FETCH_TIMEOUT } from '../src/common/common-types';
import { getBundlerChainConfig } from '../src/configs/bundler-common';

const universalModuleAddress = '0x3223f2B4AAe115aa45C642562591EddceD741576';

export const deployUniversalModule = async (chainId: number, signer: Wallet) => {
    const rpcUrl = getBundlerChainConfig(chainId).rpcUrl;
    const network = new Network('', chainId);
    const fetchRequest = new FetchRequest(rpcUrl);
    fetchRequest.timeout = PROVIDER_FETCH_TIMEOUT;
    const provider = new JsonRpcProvider(fetchRequest, network, { batchMaxCount: 1, staticNetwork: network });
    signer = signer.connect(provider);

    const feeData = await provider.getFeeData();

    const code = await provider.getCode(universalModuleAddress);
    if (code.length > 2) {
        console.log('Universal module already deployed');
        return;
    }
    console.log(JSON.stringify(feeData));
    let gasPrice: any = feeData.gasPrice;
    let maxFeePerGas: any = null;
    let maxPriorityFeePerGas: any = null;

    const r = await signer.sendTransaction({
        type: 0,
        to: '0x4e59b44847b379578588920ca78fbf26c0b4956c',
        data: universalModuleData,
        gasPrice,
        maxFeePerGas,
        maxPriorityFeePerGas,
    });

    console.log(r);
};

const universalModuleData = `0x00000000000000000000000000000000000000000000000000000000000000006080806040523461001657610dcc908161001c8239f35b600080fdfe6040608081526004908136101561001557600080fd5b6000803560e01c80631626ba7e1461043b5780632ede3bc0146103b9578063715018a614610349578063a3f4df7e146102e9578063f2fde38b14610233578063f44c339d146101ab578063fa54416114610153578063ffa1ad74146100d45763fff35b721461008357600080fd5b346100cd576003199082823601126100cd5783359167ffffffffffffffff83116100d0576101609083360301126100cd57506020926100c69160243591016105af565b9051908152f35b80fd5b5080fd5b5090346100d057816003193601126100d0578051918183019083821067ffffffffffffffff831117610140575061013c93508152600582527f302e322e3000000000000000000000000000000000000000000000000000000060208301525191829182610570565b0390f35b634e487b7160e01b815260418552602490fd5b5082346100d05760203660031901126100d0576001600160a01b038381610178610537565b169384815280602052205416918215610195576020838551908152f35b8351633d3fff5360e21b81529182015260249150fd5b50913461022f57606036600319011261022f5760243567ffffffffffffffff811161022b576101dd90369083016104eb565b90604435936001600160a01b03851685036100cd575092610201916020943561086c565b90517fffffffff000000000000000000000000000000000000000000000000000000009091168152f35b8380fd5b8280fd5b5091903461022f57602036600319011261022f5761024f610537565b803b6102ca576001600160a01b038091169283156102bc57503384528360205281842054169083208273ffffffffffffffffffffffffffffffffffffffff19825416179055337fc8894f26f396ce8c004245c8b7cd1b92103a6e4302fcbab883987149ac01b7ec8480a480f35b82516307e179e960e31b8152fd5b826001600160a01b0360249351926377817ac360e01b84521690820152fd5b5090346100d057816003193601126100d057805161013c9161030a8261047b565b602382527f556e6976657273616c204f776e657273686970205265676973747279204d6f64602083015262756c6560e81b818301525191829182610570565b508091346103b657816003193601126103b657338252816020526001600160a01b03818320541690822073ffffffffffffffffffffffffffffffffffffffff198154169055337fc8894f26f396ce8c004245c8b7cd1b92103a6e4302fcbab883987149ac01b7ec8380a480f35b50fd5b50913461022f57602036600319011261022f576103d4610537565b338452836020526001600160a01b039081848620541661042557169081156102bc575081602093338152808552209073ffffffffffffffffffffffffffffffffffffffff1982541617905551308152f35b8351632c4dfb7d60e21b81523381850152602490fd5b50346100cd57816003193601126100cd576024359067ffffffffffffffff82116100cd575060209261047361020192369083016104eb565b33913561086c565b6060810190811067ffffffffffffffff82111761049757604052565b634e487b7160e01b600052604160045260246000fd5b90601f8019910116810190811067ffffffffffffffff82111761049757604052565b67ffffffffffffffff811161049757601f01601f191660200190565b81601f8201121561053257803590610502826104cf565b9261051060405194856104ad565b8284526020838301011161053257816000926020809301838601378301015290565b600080fd5b600435906001600160a01b038216820361053257565b60005b8381106105605750506000910152565b8181015183820152602001610550565b60409160208252610590815180928160208601526020868601910161054d565b601f01601f1916010190565b519065ffffffffffff8216820361053257565b9190610140830135601e19843603018112156105325783019182359267ffffffffffffffff80851161053257602092838301958036038713610532578301604096878583031261053257359083821161053257879186806106149301918701016104eb565b930135966001600160a01b039788811603610532573594604184511461084a57835184019560a0858789019803126105325761065186860161059c565b9061065d89870161059c565b6060870151906080880151878111610532578801968a603f89011215610532578988015198818a11610497578b8b8e9a60059b8d8d1b9281519e8f906106a5838701836104ad565b81520192820101928311610532578f8e9101915b83831061083a575050505060a081015191821161053257018a603f8201121561053257808a01518c9b6106f76106ee836104cf565b9d519d8e6104ad565b818d528d828401011161053257610713918d8c8e01910161054d565b8a51898101917fffffffffffff000000000000000000000000000000000000000000000000000090818760d01b16845260d01b1695866026830152602c820152602c81526107608161047b565b519020986000995b88518b10156107c7578a881b89018a0151908c6000838310156107ba57505060005289528a6000205b9960001981146107a45760010199610768565b634e487b7160e01b600052601160045260246000fd5b91909282528b5220610791565b939950955095509550849197509791970361082f576107e79316916108aa565b156108285779ffffffffffff00000000000000000000000000000000000000009065ffffffffffff9081811661082157505b60a01b161790565b9050610819565b5050600190565b505050505050600190565b82518152918101918e91016106b9565b9491509591925061085d945016916108aa565b1561086757600090565b600190565b9061087792916108aa565b61089f577fffffffff0000000000000000000000000000000000000000000000000000000090565b630b135d3f60e11b90565b90916001600160a01b03809116906000938285526020938585526040838188205416948515610b9f57506041835110610b8f577f19457468657265756d205369676e6564204d6573736167653a0a333200000000875281601c52603c87208461091e6109168684610ccf565b919091610bb5565b168614610b8257958151608081019067ffffffffffffffff9181811083821117610a7f578452604281528281016060368237815115610b6e576030815381519960019a8b1015610b5a576078602184015360415b8b8111610adf5750610a9d576109ee84928c926109de603a895180936109ce898301967f18426974636f696e205369676e6564204d6573736167653a0a000000000000008852602160f91b60398501525180928585019061054d565b810103601a8101845201826104ad565b875192839283925192839161054d565b8101039060025afa15610a935788518351908382019081528382528482019282841090841117610a7f579082610a2d81938d958852835192839161054d565b8101039060025afa15610a76575082610a4a610916848951610ccf565b168414610a6d57610a5e9161091691610ccf565b1614610a68575090565b905090565b50505050905090565b513d87823e3d90fd5b634e487b7160e01b8b52604160045260248bfd5b82513d8a823e3d90fd5b60648486519062461bcd60e51b825280600483015260248201527f537472696e67733a20686578206c656e67746820696e73756666696369656e746044820152fd5b90600f81166010811015610b46578451831015610b46577f3031323334353637383961626364656600000000000000000000000000000000901a86838601015360041c908015610b325760001901610972565b634e487b7160e01b8d52601160045260248dfd5b634e487b7160e01b8e52603260045260248efd5b634e487b7160e01b8c52603260045260248cfd5b634e487b7160e01b8b52603260045260248bfd5b5050505050505050600190565b51632bb1a9c560e11b8152600490fd5b6024915190633d3fff5360e21b82526004820152fd5b6005811015610cb95780610bc65750565b60018103610c135760405162461bcd60e51b815260206004820152601860248201527f45434453413a20696e76616c6964207369676e617475726500000000000000006044820152606490fd5b60028103610c605760405162461bcd60e51b815260206004820152601f60248201527f45434453413a20696e76616c6964207369676e6174757265206c656e677468006044820152606490fd5b600314610c6957565b60405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c604482015261756560f01b6064820152608490fd5b634e487b7160e01b600052602160045260246000fd5b906041815114600014610cfd57610cf9916020820151906060604084015193015160001a90610d07565b9091565b5050600090600290565b9291907f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08311610d8a5791608094939160ff602094604051948552168484015260408301526060820152600093849182805260015afa15610d7d5781516001600160a01b03811615610d77579190565b50600190565b50604051903d90823e3d90fd5b5050505060009060039056fea2646970667358221220eb102b78cf18c4deb9267e137c8e6b19dbfce93be5d3647da18d4815d51dc53b64736f6c63430008110033`;
