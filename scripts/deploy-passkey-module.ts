import { FetchRequest, JsonRpcProvider, Network, Wallet } from 'ethers';
import { PROVIDER_FETCH_TIMEOUT } from '../src/common/common-types';
import { getBundlerChainConfig } from '../src/configs/bundler-common';

const data = `0x000000000000000000000000000000000000000000000000000000000000000060808060405234610016576117e5908161001c8239f35b600080fdfe60806040526004361015610013575b600080fd5b6000803560e01c908163032ff9f1146101915781631626ba7e1461019157816373016096146100a4575080638d2bc5291461009b578063a3f4df7e14610092578063f5cb8cd914610089578063ffa1ad74146100805763fff35b721461007857600080fd5b61000e6107e1565b5061000e610782565b5061000e6105f7565b5061000e610511565b5061000e610477565b3461018e57606036600319011261018e5760443567ffffffffffffffff811161018a576100d76040913690600401610312565b919092338152806020522054151580610161575b6101495761011361013a926100fe610219565b92600435845260243560208501523691610253565b6040820152610135336001600160a01b03166000526000602052604060002090565b610882565b604051308152602090f35b0390f35b604051632c4dfb7d60e21b8152336004820152602490fd5b506001610181336001600160a01b03166000526000602052604060002090565b015415156100eb565b5080fd5b80fd5b505061000e6102a8565b50634e487b7160e01b600052604160045260246000fd5b6060810190811067ffffffffffffffff8211176101ce57604052565b6101d661019b565b604052565b6040810190811067ffffffffffffffff8211176101ce57604052565b90601f8019910116810190811067ffffffffffffffff8211176101ce57604052565b60405190610226826101b2565b565b60209067ffffffffffffffff8111610246575b601f01601f19160190565b61024e61019b565b61023b565b92919261025f82610228565b9161026d60405193846101f7565b82948184528183011161000e578281602093846000960137010152565b9080601f8301121561000e578160206102a593359101610253565b90565b503461000e57604036600319011261000e5760243567ffffffffffffffff811161000e576102e76102df602092369060040161028a565b600435610c85565b6040517fffffffff000000000000000000000000000000000000000000000000000000009091168152f35b9181601f8401121561000e5782359167ffffffffffffffff831161000e576020838186019501011161000e57565b6001600160a01b0381160361000e57565b90600182811c92168015610381575b602083101461036b57565b634e487b7160e01b600052602260045260246000fd5b91607f1691610360565b906040519182600082549261039f84610351565b90818452600194858116908160001461040c57506001146103c9575b5050610226925003836101f7565b9093915060005260209081600020936000915b8183106103f4575050610226935082010138806103bb565b855488840185015294850194879450918301916103dc565b91505061022694506020925060ff191682840152151560051b82010138806103bb565b60005b8381106104425750506000910152565b8181015183820152602001610432565b9060209161046b8151809281855285808601910161042f565b601f01601f1916010190565b503461000e57602036600319011261000e576001600160a01b0360043561049d81610340565b166000526000602052604060002080546101456104c160026001850154940161038b565b60405193849384526020840152606060408401526060830190610452565b604051906020820182811067ffffffffffffffff821117610504575b60405260008252565b61050c61019b565b6104fb565b503461000e57600036600319011261000e57610145604051610532816101b2565b602281527f506173734b657973204f776e657273686970205265676973747279204d6f64756020820152616c6560f01b6040820152604051918291602083526020830190610452565b96926102a59a98956105d2956105b6926105c4956105e09a958c5260208c015260408b015260608a01526101408060808b0152890190610452565b9087820360a0890152610452565b9085820360c0870152610452565b9083820360e0850152610452565b921515610100820152610120818403910152610452565b503461000e5760a036600319011261000e5760243560043567ffffffffffffffff60443581811161000e57610630903690600401610312565b909160843581811161000e5761064a903690600401610312565b8101929060c08185031261000e57602081013592604082013594606083013582811161000e578161067c91850161028a565b91608084013581811161000e578261069591860161028a565b9360a081013591821161000e5701906106ad9161028a565b926106b96064356109f6565b6106c290610baa565b6106cb90610ef6565b956106d7858886610a24565b918a82888c87604051806106eb818b610a0d565b03905a916000916002602094fa159d61075b966101459f600061072a61071e61075196602094610775575b835190610a85565b60405191828092610a0d565b039060025afa15610768575b60005196610742610219565b94855260208501523691610253565b6040820152610ff4565b956040519a8b9a8b61057b565b610770610a78565b610736565b61077d610a78565b610716565b503461000e57600036600319011261000e576101456040516107a3816101db565b600581527f302e322e300000000000000000000000000000000000000000000000000000006020820152604051918291602083526020830190610452565b503461000e5760031960403682011261000e576004359067ffffffffffffffff821161000e5761016090823603011261000e5761082660209160243590600401610974565b604051908152f35b90601f811161083c57505050565b600091825260208220906020601f850160051c83019410610878575b601f0160051c01915b82811061086d57505050565b818155600101610861565b9092508290610858565b81518155602060406002828501519360019485820155019301519081519167ffffffffffffffff8311610967575b6108c4836108be8754610351565b8761082e565b81601f84116001146108fd57509282939183926000946108f2575b50501b916000199060031b1c1916179055565b0151925038806108df565b919083601f19811661091488600052602060002090565b946000905b8883831061094d5750505010610934575b505050811b019055565b015160001960f88460031b161c1916905538808061092a565b858701518855909601959485019487935090810190610919565b61096f61019b565b6108b0565b61014081013590601e198136030182121561000e570180359167ffffffffffffffff9283811161000e576020830190803603821361000e5783019060408483031261000e573593841161000e5760406109db6109e8956020806109e395019187010161028a565b930135610340565b610da1565b6109f157600190565b600090565b9060405191602083015260208252610226826101db565b90610a206020928281519485920161042f565b0190565b610226919392936040519485918351610a458160209687808801910161042f565b8301610a598251809387808501910161042f565b01610a6c8251809386808501910161042f565b010380855201836101f7565b506040513d6000823e3d90fd5b60406102269193929381519481610aa687935180926020808701910161042f565b82019060208201520360208101855201836101f7565b60405190610ac9826101b2565b604082527f6768696a6b6c6d6e6f707172737475767778797a303132333435363738392b2f6040837f4142434445464748494a4b4c4d4e4f505152535455565758595a61626364656660208201520152565b50634e487b7160e01b600052601160045260246000fd5b9060028201809211610b4057565b610226610b1b565b908160021b917f3fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811603610b4057565b90610b8282610228565b610b8f60405191826101f7565b8281528092610ba0601f1991610228565b0190602036910137565b805115610c7c57610bb9610abc565b610bdd610bd8610bd3610bcc8551610b32565b6003900490565b610b48565b610b78565b9160208301918182518301915b828210610c2a57505050600390510680600114610c1757600214610c0c575090565b603d90600019015390565b50603d9081600019820153600119015390565b9091936004906003809401938451600190603f9082828260121c16880101518553828282600c1c16880101518386015382828260061c1688010151600286015316850101519082015301939190610bea565b506102a56104df565b90610c8f91610da1565b610cb7577fffffffff0000000000000000000000000000000000000000000000000000000090565b630b135d3f60e11b90565b81601f8201121561000e578051610cd881610228565b92610ce660405194856101f7565b8184526020828401011161000e576102a5916020808501910161042f565b909160c08284031261000e5781519260208301519260408101519260608201519167ffffffffffffffff9283811161000e5784610d42918301610cc2565b93608082015184811161000e5781610d5b918401610cc2565b9360a083015190811161000e576102a59201610cc2565b90604051610d7f816101b2565b6040610d9c6002839580548552600181015460208601520161038b565b910152565b60206000610e0161071e610dde948484610dee61071e610de8610dcf610de39c868082518301019101610d04565b95939450939f919e90996109f6565b610baa565b610ef6565b90610a24565b039060025afa1561077557835190610a85565b039060025afa15610e71575b60005190610e36610e31336001600160a01b03166000526000602052604060002090565b610d72565b9283511580610e65575b610e4d576102a593610ff4565b60405163ce777ecf60e01b8152336004820152602490fd5b50602084015115610e40565b610e79610a78565b610e0d565b600019810191908211610b4057565b50634e487b7160e01b600052603260045260246000fd5b906020918051821015610eb657010190565b610ebe610e8d565b010190565b8015610ed1575b6000190190565b610ed9610b1b565b610eca565b6001906000198114610eee570190565b610a20610b1b565b9081515b80151580610fc9575b15610f1657610f1190610ec3565b610efa565b610f1f81610b78565b906000805b828110610f3357509193505050565b610f7e90602b60f81b610f67610f5a610f4c848b610ea4565b516001600160f81b03191690565b6001600160f81b03191690565b03610f8357602d610f788287610ea4565b53610ede565b610f24565b602f60f81b6001600160f81b0319610f9e610f4c848b610ea4565b1603610fb057605f610f788287610ea4565b610fbd610f4c8289610ea4565b831a610f788287610ea4565b50603d60f81b6001600160f81b0319610fed610f4c610fe785610e7e565b87610ea4565b1614610f03565b9291908015801561122d575b8015611203575b80156111d9575b6111d0578351936110256020820195865190611489565b156111c6576111bb6102a595611039611533565b92611042610219565b6001815260016020820152600060408201528452519051611061610219565b91825260208201526001604082015261108060208401918083526115d0565b906111ac61109660408601938085528351611586565b926060860193845261119c61118c6110ac610219565b7f6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c29681527f4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f560208201526001604082015261110f60808a0191808352875190611586565b60a08a01526111218151855190611586565b60c08a01526111338151885190611586565b60e08a015261114281516115d0565b906111576101008b0192808452885190611586565b6101208b015261116a8251865190611586565b6101408b015261117d8251895190611586565b6101608b015251905190611586565b6101808801948186525190611586565b6101a08701528251905190611586565b6101c085015251905190611586565b6101e0820152611235565b5050505050600090565b50505050600090565b507fffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc63255182101561100e565b507fffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551811015611007565b508115611000565b91611242909391936113fd565b9182917fffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc6325518094819209928509906001908192600094608091825b61129557505050509061128f9291611350565b50061490565b8661130f575b8060fe1c600c8360fc1c1617806112c6575b506112bf90600292831b921b92610ec3565b918261127c565b6112bf9661130393986112dc8388999599611331565b51519160406112fa60206112f0878c611331565b510151958a611331565b510151946115f0565b969195909594906112ad565b939561132091956113269397611705565b91611705565b95919490949361129b565b906010811015611343575b60051b0190565b61134b610e8d565b61133c565b92919081156113f1578160006ffffffffeffffffffffffffffffffffff60601b1984818096116113e7575b505060405191602083526020808401526020604084015260608301527fffffffff00000001000000000000000000000000fffffffffffffffffffffffd60808301528360a083015260208260c0816005600019fa1561018e575082905181808280098097099509900990565b069150833861137b565b50509050600090600090565b7fffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551808211611480575b60405191602083526020808401526020604084015260608301527fffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc63254f608083015260a082015260208160c0816005600019fa1561000e575190565b80910690611426565b6ffffffffeffffffffffffffffffffffff60601b199081811080159061150a575b611502577f5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b8282817fffffffff00000001000000000000000000000000fffffffffffffffffffffffc81838197090809089180091490565b505050600090565b50818310156114aa565b60405190611521826101b2565b60006040838281528260208201520152565b6040519061020080830183811067ffffffffffffffff821117611579575b6040528260005b82811061156457505050565b60209061156f611514565b8184015201611558565b61158161019b565b611551565b6115b391611592611514565b508151916040602082015191015182519160406020850151940151946115f0565b90604051926115c1846101b2565b83526020830152604082015290565b6115b3906115dc611514565b508051906040602082015191015191611705565b9395938261160057505050929190565b85969396156116fc5785966ffffffffeffffffffffffffffffffffff60601b19948580808a800992818881808080848009809a099e88098a0996099009918409978881106116f5575b868982038a82828009838184098787106116ec575b8492918391828a8a0392818480099509938380866002098308908181106116e5575b039d8e918b09938181106116de575b0390098181106116d7575b039c890909981491826116cd575b50506116b657505050929190565b9193955091506116c69350611705565b9192909190565b14905038806116a8565b820161169a565b830161168f565b8401611680565b9584019561165e565b8601611649565b95509350919050565b9290916ffffffffeffffffffffffffffffffffff60601b19809181858009958280808080808c87096004099a800960080992818080808089800980097fffffffff00000001000000000000000000000000fffffffffffffffffffffffc09928009600309088189600209828280098181106117a8575b038981809b106117a1575b03900981811061179a575b03940960020990565b8301611791565b8301611786565b830161177b56fea2646970667358221220e015963d0d6d04f974dfc0a695d8ff31668f21fe9e40c7a2f2de507e6bee72c064736f6c63430008110033`;

const passkeyAddress = '0x1c46DCAd77572A9f6F522C4524B49337aFa12db9';
export const deployPassKeyModule = async (chainId: number, signer: Wallet) => {
    const rpcUrl = getBundlerChainConfig(chainId).rpcUrl;
    const network = new Network('', chainId);
    const fetchRequest = new FetchRequest(rpcUrl);
    fetchRequest.timeout = PROVIDER_FETCH_TIMEOUT;
    const provider = new JsonRpcProvider(fetchRequest, network, { batchMaxCount: 1, staticNetwork: network });
    signer = signer.connect(provider);

    const feeData = await provider.getFeeData();

    const code = await provider.getCode(passkeyAddress);
    if (code.length > 2) {
        console.log('Passk module already deployed');
        return;
    }
    console.log(JSON.stringify(feeData))
    let gasPrice: any = feeData.gasPrice;
    let maxFeePerGas: any = null;
    let maxPriorityFeePerGas: any = null;

    const r = await signer.sendTransaction({
        type: 0,
        to: '0x4e59b44847b379578588920ca78fbf26c0b4956c',
        data,
        gasPrice,
        maxFeePerGas,
        maxPriorityFeePerGas,
    });

    console.log(r);
};
